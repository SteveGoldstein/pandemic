---
title: "CDC_Housing"
author: "`r paste('Brian Yandell,', format(Sys.time(), '%d %B %Y'))`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 7, fig.height = 5)
```

This document summarizes housing information. The R code file can be found in the [pandemic github repository](https://github.com/UW-Madison-DataScience/pandemic/blob/master/cdc_housing.Rmd).

```{r}
library(tidyverse)
library(lubridate)
kprint <- function(x) {
  if(interactive()) {
    print(x)
  } else {
    knitr::kable(x)
  }
}
```

```{r}
filename <- scan("data/housing_data_url.txt", "text")
# Need to download this file; could use boxr package
cdc0 <- read.csv("data/matchforCDC-PHI.csv") %>%
  select(PatientID, 
         ResultDate, CollectionDate, ConfirmedDate, TracedDate,
         Residence_Hall, Hall, House_Name, Room,
         fakeroom, FAKEHALL, FAKEHOUS, Positive) %>%
  filter(!is.na(PatientID)) %>%
  mutate(FAKEHALL = ifelse(is.na(FAKEHALL), -1, FAKEHALL),
         Campus = ifelse(Residence_Hall == "off campus", "off", "on")) %>%
  select(-Residence_Hall)
# Only a few off campus and no positives, so drop them.
cdc0 <- cdc0 %>%
  filter(Campus == "on") %>%
  select(-Campus)
# Collapse Hall 6 room numbers
cdc0 <- cdc0 %>%
  mutate(Room = ifelse(FAKEHALL == 6, (Room %% 100) + 20 * floor(Room / 100), Room))
```

```{r}
SmallHall <- (cdc0 %>%
  filter(Positive == 1) %>%
  count(FAKEHALL) %>%
  filter(n < 15))$FAKEHALL
CleanHouse <- (cdc0 %>%
  filter(Positive == 1,
         FAKEHALL %in% SmallHall) %>%
  count(FAKEHALL, FAKEHOUS))$FAKEHOUS
cdc0 <- cdc0 %>%
  mutate(FAKEHALL = ifelse(FAKEHALL %in% SmallHall, 0, FAKEHALL)) %>%
  filter((FAKEHALL != 0) | (FAKEHALL == 0 & FAKEHOUS %in% CleanHouse))
```

```{r}
cdc <- cdc0 %>%
  filter(FAKEHALL != -1)
```

```{r}
IDs <- sort(unique(cdc$PatientID))
```

```{r}
cdc_date <- cdc %>%
  pivot_longer(ResultDate:TracedDate, names_to = "Event", values_to = "Date") %>%
  distinct(PatientID, Date, Event, .keep_all = TRUE) %>%
  mutate(Event = factor(Event, c("CollectionDate", "ResultDate", "ConfirmedDate", "TracedDate")),
         ID = match(PatientID, IDs),
         Date = as.Date(Date, "%m/%d/%Y")) %>%
  filter(Date > as.Date("2020-01-01"))
```

```{r}
countroom <- function(room) {
  out <- room %>%
    mutate(PatientID = paste0("N", match(PatientID, sort(unique(PatientID)))))
  if(length(unique(out$PatientID)) > 1) {
    out <- out%>%
      pivot_wider(names_from = "PatientID", values_from = "Positive") %>%
      arrange(Date) %>%
      fill(contains("N")) %>%
      pivot_longer(any_of(paste0("N",1:10)), 
                   names_to = "roommate", values_to = "score") %>%
      ungroup %>%
      group_by(Date) %>%
      summarize(score = sum(score, na.rm = TRUE)) %>%
      ungroup
  }
  out
}
```

```{r}
oneroom <- cdc_date %>%
  filter(Event == "CollectionDate") %>%
  group_by(FAKEHALL, FAKEHOUS, fakeroom, PatientID) %>%
  summarize(Date = ifelse(max(Positive) == 1, min(Date[Positive == 1]), max(Date)),
            Positive = max(Positive)) %>%
  ungroup %>%
  group_by(FAKEHALL, FAKEHOUS, fakeroom) %>%
  arrange(Date) %>%
  mutate(Positive = cumsum(Positive),
         Date = max(Date) - min(Date),
         Positive = max(Positive),
         Roommates = n()) %>%
  ungroup %>%
  filter(Roommates == 2,
         !is.na(Date))
one <- oneroom %>%
  group_by(FAKEHALL, FAKEHOUS, Positive) %>%
  summarize(center = median(Date),
            spread = IQR(Date),
            HouseSize = n()) %>%
  ungroup
```

Number of rooms with 0, 1 or 2 students positive:

```{r}
one %>%
  group_by(FAKEHALL, Positive) %>%
  summarize(HouseSize = sum(HouseSize)) %>%
  ungroup %>%
  mutate(Positive = paste0("Pos", Positive)) %>%
  pivot_wider(names_from = "Positive", values_from = "HouseSize", values_fill = 0) %>%
  mutate(Rooms = Pos0 + Pos1 + Pos2,
         PctPos = round(100 * (Pos1 + 2 * Pos2) / Rooms, 2)) %>%
  arrange(desc(PctPos)) %>%
  kprint()
```
`FAKEHALL` 0 is aggregation of halls with fewer than 15 students reporting. Next plot summarizes by House (point) within Hall (facet) differences within rooms of last collection date; center = median, spread = IQR.
Subsequent plots show individual students per horizontal line (sometimes with a little jitter) organized by room. Coloring highlights time course of dates, positive vs negative, or room. Only considering rooms with exactly two roommates, as other sizes might be due to room transfers.

\newpage

### Cumulative Counts of Positives by Collection Date

```{r}
cdc_sum <- cdc_date %>%
  filter(Event == "CollectionDate", Positive == 1) %>%
  arrange(Date) %>%
  count(FAKEHALL, Date, name = "count") %>%
  group_by(FAKEHALL) %>%
  mutate(count = cumsum(count)) %>%
  ungroup
cdc_tot <- cdc_date %>%
  filter(Event == "CollectionDate", Positive == 1) %>%
  arrange(Date) %>%
  count(Date, name = "all") %>%
  mutate(all = cumsum(all))
cdc_sum <- left_join(
  cdc_sum,
  cdc_tot,
  by = "Date")
```

```{r}
ggplot(cdc_sum) +
  aes(Date, count, col = factor(FAKEHALL), group = factor(FAKEHALL)) +
  scale_y_log10() +
  theme(legend.position = "none") +
  ylab("Cumulative Positive by Hall") +
  geom_line(size = 2) +
  ggtitle("Cumulative Positives by Hall over Time")
```

```{r}
ggplot(cdc_sum %>% mutate(Hall = factor(FAKEHALL))) +
  aes(all, count, col = Hall, group = Hall) +
  geom_line(size = 2) +
  geom_abline(slope = 1, intercept = 0, col = "gray") +
  scale_x_log10() +
  scale_y_log10() +
  xlab("Cumulative Positive Overall") +
  ylab("Cumulative Positive by Hall") +
  theme(legend.position = "none") +
  ggtitle("Breakdown of Cumulative Positives by Hall")
```

```{r}
# Get one record per student
house <- cdc_date %>%
  filter(Event == "CollectionDate",
         !is.na(Date),
         !is.na(Positive)) %>%
  group_by(FAKEHALL, FAKEHOUS, Room,
           fakeroom, PatientID) %>%
  arrange(Date) %>%
  summarize(PrevDate = nth(Date, -2),
            Date = last(Date),
            Positive = last(Positive)) %>%
  ungroup
roomsize <- house %>%
  count(FAKEHALL, FAKEHOUS, fakeroom, Room)
# Restrict to rooms with exactly two students (avoiding turnover for now)
house <-
  left_join(house, roomsize, by = c("FAKEHALL", "FAKEHOUS", "fakeroom", "Room")) %>%
  filter(n == 2) %>%
  select(-n) %>%
  group_by(FAKEHALL, FAKEHOUS) %>%
  mutate(students = n()) %>%
  ungroup %>%
  mutate(house = FAKEHOUS,
         FAKEHOUS = paste0(FAKEHOUS, " (", students, ")"))
```

```{r}
one_date <- house %>%
  group_by(FAKEHALL, FAKEHOUS, house, fakeroom) %>%
  arrange(Date) %>%
  summarize(Delay = max(Date) - min(Date),
         Positive = sum(Positive),
         Date = first(Date)) %>%
  ungroup %>%
  filter(Positive == 2) %>%
  # Kludge used once only
  group_by(FAKEHALL) %>%
  mutate(roomID = factor(rank(10000 * house + fakeroom))) %>%
  ungroup
```

### Positive Cases within Rooms over Date

Idea here is to just look at dates of positive cases and link cases within rooms by a horizontal line. First plots colors rooms by number of positive cases. Early plots have two points per students for the most recent two tests. Later plots color rooms by house to look for patterns that cut across houses in halls.

```{r}
room_rank <- function(fakeroom) {
  roomID <- rank(sort(unique(fakeroom)))
  names(roomID) <- sort(unique(fakeroom))
  roomID[as.character(fakeroom)]
}
pair_house <- function(house, neg = FALSE) {
  pos_pair <- house %>%
    arrange(Date, fakeroom)
  if(!neg) {
    pos_pair <- pos_pair %>%
      filter(Positive == 1)
  }
  pos_room <- pos_pair %>%
    group_by(fakeroom) %>%
    arrange(Date) %>%
    summarize(RoomPos = sum(Positive),
              RoomID = Room[1]) %>%
    ungroup %>%
    mutate(RoomID = 1 + RoomID - min(RoomID))
  out <- 
    left_join(
      pos_pair,
      pos_room,
      by = "fakeroom") %>%
    mutate(RoomPos = factor(ifelse(RoomPos == 1 & Positive == 0, "0.1", as.character(RoomPos)), c("2","1","0.1","0")))
  if(nrow(out)) {
    out %>%
    # jitter roommates if 2 entries per room
    group_by(Room) %>%
    mutate(RoomID = ifelse(!neg & RoomPos == 1, RoomID, RoomID + c(-0.2,0.2))) %>%
    ungroup %>%
    pivot_longer(PrevDate:Date, names_to = "Prev", values_to = "Date") %>%
    group_by(RoomID) %>%
    mutate(TestResult = ifelse(neg & Positive == 0, rep(1,2), 1:2)) %>%
    ungroup %>%
    mutate(TestResult = c("Negative","Positive")[TestResult])
  } else {
    out
  }
}
```

```{r fig.height = 4}
ggplot(pair_house(house %>% filter(FAKEHALL == 10, grepl("^39 ", FAKEHOUS)))) +
  aes(Date, RoomID, col = RoomPos, group = RoomID, shape = TestResult) +
  geom_vline(xintercept = as.Date(c("2020-08-25","2020-09-01","2020-09-04","2020-09-09","2020-09-17")),
             linetype = "dashed", col = "black") +
  geom_line() +
  geom_point() +
#  facet_wrap(~ house, scale = "free") +
#  theme(legend.position = "none") +
  scale_color_manual(values = c("blue","red","darkgrey","lightgrey")) +
  scale_shape_manual(values = c(21,19)) +
  ggtitle("Positive Students by Room Burden across Rooms in House")

```

```{r fig.height = 4}
ggplot(pair_house(house %>% 
                    filter(FAKEHALL == 10, grepl("39", FAKEHOUS)), TRUE) %>%
         mutate(RoomPos = factor(ifelse(RoomPos == 1 & Positive == 0, "0.1", as.character(RoomPos)), c("2","1","0.1","0")))) +
  aes(Date, RoomID, col = RoomPos, group = RoomID, shape = TestResult) +
  geom_vline(xintercept = as.Date(c("2020-08-25","2020-09-01","2020-09-04","2020-09-09","2020-09-17")),
             linetype = "dashed", col = "black") +
  geom_line() +
  geom_point() +
#  facet_wrap(~ house, scale = "free") +
#  theme(legend.position = "none") +
  scale_shape_manual(values = c(21,19)) +
  scale_color_manual(values = c("blue","red","darkgrey","lightgrey")) +
  ggtitle("All Students by Room Burden across Rooms in House")
```

```{r}
plot_hall <- function(house, hallID, neg = FALSE) {
object <- house %>% filter(FAKEHALL == hallID)
out <- bind_rows(
    map(split(object, object$FAKEHOUS), pair_house, neg),
    .id = "house") %>%
  mutate(RoomPos = factor(ifelse(RoomPos == 1 & Positive == 0, "0.1", as.character(RoomPos)), c("2","1","0.1","0")))
if(neg) {
  gtitle <- "All Students by Room Burden across House Rooms in Hall"
} else {
  gtitle <- "Positive Students by Room Burden across House Rooms in Hall"
}
ggplot(out) +
  aes(Date, RoomID, col = RoomPos, group = RoomID, shape = TestResult) +
  geom_vline(xintercept = as.Date(c("2020-08-25","2020-09-01","2020-09-04","2020-09-09","2020-09-17")),
             linetype = "dashed", col = "black") +
  geom_line() +
  geom_point() +
  facet_wrap(~ house) +
  scale_shape_manual(values = c(21,19)) +
  scale_color_manual(values = c("blue","red","darkgrey","lightgrey")) +
  theme(#legend.position = "none", 
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle(paste(gtitle, hallID))
}
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 10, TRUE)
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 16, TRUE)
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 3, TRUE)
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 5, TRUE)
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 6, TRUE)
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 8, TRUE)
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 12, TRUE)
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 13, TRUE)
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 0, TRUE)
```

```{r}
date_infected <- function(x) {
  if(!any(is.na(x$Date))) {
    y <- tibble(Date = seq(from = first(x$Date), to = last(x$Date), by = 1)) %>%
      mutate(PatientID = x$PatientID[1],
             Infected = seq(from = 0, to = 1, length.out = length(Date)))
    full_join(x %>% select(-Date),y,by = "PatientID")
  } else {
    x %>% 
      mutate(Infected = 1)
  }
}
house_infected <- function(datehouse) {
  datehouse <- split(datehouse, datehouse$PatientID)
  bind_rows(
    map(datehouse, date_infected),
    .id = "PatientID")
}
```

```{r eval=FALSE}
out <- split(house, house$FAKEHALL)
out <- bind_rows(
  map(out, house_infected),
  .id = "hall")
```

```{r}
bead_house <- function(house) {
  dates <- 
    bind_rows(
      map(
        split(house, house$FAKEHOUS),
        pair_house),
      .id = "FAKEHOUS") %>%
    filter(Positive > 0)
  dates <- split(dates, dates$FAKEHOUS)
  dates <- bind_rows(
    map(dates, house_infected), .id = "FAKEHOUS") %>%
    group_by(FAKEHALL, FAKEHOUS, Date, students) %>%
    summarize(Infected = sum(Infected)) %>%
    ungroup %>%
    filter(!is.na(Date))
  dates_total <- dates %>%
    group_by(FAKEHOUS) %>%
    summarize(CumInf = sum(Infected)) %>%
    ungroup
  left_join(
    dates,
    dates_total,
    by = "FAKEHOUS") %>%
    mutate(FAKEHOUS = reorder(FAKEHOUS, CumInf)) %>%
    select(-CumInf)
}
```

```{r}
dates <- bind_rows(
  map(
    split(house, house$FAKEHALL),
    bead_house),
  .id = "FAKEHALL")
```

Inferred positives fill in ramped values (0 to 1) from last negative test to positive test, recognizing that student could have turned positive at any time between tests. Dots are proportional to number of inferred infectives.

```{r}
ggplot(dates %>% filter(FAKEHALL == 10)) +
  aes(Date, FAKEHOUS, size = Infected) +
  geom_vline(xintercept = as.Date(c("2020-08-25","2020-09-01","2020-09-04","2020-09-09","2020-09-17")),
             linetype = "dashed", col = "gray") +
  geom_point() +
  geom_line(size = 1) +
  ggtitle("Inferred Positives by House for FAKEHALL 10")
```

```{r}
ggplot(dates %>% filter(FAKEHALL %in% c(10,16))) +
  aes(Date, FAKEHOUS, size = Infected) +
  geom_vline(xintercept = as.Date(c("2020-08-25","2020-09-01","2020-09-04","2020-09-09","2020-09-17")),
             linetype = "dashed", col = "gray") +
  geom_point() +
  geom_line(size = 1) +
  facet_wrap(~ FAKEHALL, scales = "free_y") +
  ggtitle("Inferred Positives by House for Larger Halls")
```

```{r fig.width = 10, fig.height = 10}
ggplot(dates) +
  aes(Date, FAKEHOUS, size = Infected) +
  geom_vline(xintercept = as.Date(c("2020-08-25","2020-09-01","2020-09-04","2020-09-09","2020-09-17")),
             linetype = "dashed", col = "gray") +
  geom_point() +
  geom_line(size = 0.5) +
  facet_wrap(~ FAKEHALL, scales = "free_y") +
  ggtitle("Inferred Positives by House and FAKEHALL")
```


```{r}
pair_hall <- function(object) {
  bind_rows(
    map(split(object, object$FAKEHOUS), pair_house),
    .id = "house") %>% 
  filter(Prev == "Date") %>%
  mutate(Week = (epiweek(Date))) %>%
  group_by(house, Week) %>%
  summarize(count = sum(Positive)) %>%
#  ungroup %>%
#  arrange(Date) %>%
#  group_by(house) %>%
#  mutate(count = cumsum(count)) %>%
  ungroup
}
```

```{r}
out <- pair_hall(house %>% filter(FAKEHALL == 10))
```

```{r}
ggplot(out) +
  aes(Week, house, size = count) +
  geom_line(size = 1) +
  geom_point() +
#  facet_wrap(~ house, scale = "free") +
  theme(legend.position = "none") +
  ggtitle("Positive Collection Dates by Room Burden across Rooms in House")
```

```{r}
out <- 
  bind_rows(
    map(split(house, house$FAKEHALL), pair_hall),
    .id = "hall")
```

```{r}
ggplot(out %>% filter(hall %in% c(10, 16))) +
  aes(Week, house, size = count) +
  geom_line(size = 1) +
  geom_point() +
  facet_wrap(~ hall, scales = "free") +
  theme(legend.position = "none") +
  ggtitle("Positive Collection Dates by House across Halls")
```

```{r fig.width = 10, fig.height = 10}
ggplot(out) +
  aes(Week, house, size = count) +
  geom_line(size = 1) +
  geom_point() +
  facet_wrap(~ hall, scales = "free") +
  theme(legend.position = "none") +
  ggtitle("Positive Collection Dates by House across Halls")
```

\newpage

### Same vs Different Rooms

```{r}
diff_house <- function(object) {
  object <- arrange(object, -Positive, Date)
  days <- outer(object$Date, object$Date, "-")
  days <- days[lower.tri(days)]
  room <- outer(object$fakeroom, object$fakeroom, "==")
  room <- room[lower.tri(room)]
  pos <- outer(object$Positive, object$Positive, "+")
  pos <- pos[lower.tri(pos)]
  roomID <- rank(sort(unique(object$fakeroom)))
  names(roomID) <- sort(unique(object$fakeroom))
  roomID <- outer(object$fakeroom, roomID[as.character(object$fakeroom)], function(x,y) y)
  roomID <- roomID[lower.tri(roomID)]
  as_tibble(
    data.frame(days = days, 
               room = c("Diff","Same")[1+room],
               pos = pos,
               roomID = roomID))
}
```

```{r}
diff_hall <- function(object) {
  bind_rows(
    map(split(object, object$FAKEHOUS), diff_house),
    .id = "house") %>%
  group_by(house, room, pos) %>%
  summarize(days_iqr = IQR(days),
            days = median(days),
            size = n()) %>%
  ungroup
}
```

```{r}
out <- 
  bind_rows(
    map(split(house, house$FAKEHALL), diff_hall),
    .id = "hall")
```

Compare all pairs of students in each house within each hall. Note middle column compares two students where one is positive and one is negative. Values below 0 for median days signify that the positive students were detected after that most recent test for the negative students.

```{r fig.width = 6, fig.height = 7}
ggplot(out %>% 
         mutate(pos = paste(pos, "Positive"),
                hall = paste("Hall", hall))) +
  aes(days, days_iqr, col = room, size = size) +
  facet_grid(hall ~ pos, scale = "free") +
  xlab("Median Days per House") +
  ylab("Day Spread per House") +
  geom_point(alpha = 0.5) +
  ggtitle("Delay in Collection Dates for Same or Different Rooms in House")
```

### Summaries by student within rooms

```{r}
both <- oneroom %>%
  filter(Positive == 2) %>%
  select(FAKEHALL, FAKEHOUS, fakeroom, PatientID)
half <- oneroom %>%
  filter(Positive == 1) %>%
  select(FAKEHALL, FAKEHOUS, fakeroom, PatientID)
cdcID <- cdc_date %>% 
  filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(both$fakeroom, both$FAKEHALL, both$FAKEHOUS)) %>%
  group_by(FAKEHALL, FAKEHOUS, PatientID) %>%
  summarize(Date = min(Date),
            fakeroom = fakeroom[1]) %>%
  ungroup %>%
  group_by(FAKEHALL) %>%
  mutate(ID = 0.25 + rank(10000 * FAKEHOUS + fakeroom, ties.method = "random") / 2,
         roomID = rank(10000 * FAKEHOUS + fakeroom)) %>%
  ungroup %>%
  select(FAKEHALL, PatientID, ID, roomID)
cdcIDh <- cdc_date %>% 
  filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(half$fakeroom, half$FAKEHALL, half$FAKEHOUS)) %>%
  group_by(FAKEHALL, FAKEHOUS, PatientID) %>%
  summarize(Date = min(Date),
            fakeroom = fakeroom[1]) %>%
  ungroup %>%
  group_by(FAKEHALL) %>%
  mutate(ID = 0.25 +rank(10000 * FAKEHOUS + fakeroom, ties.method = "random") / 2,
         roomID = rank(10000 * FAKEHOUS + fakeroom)) %>%
  ungroup %>%
  select(FAKEHALL, PatientID, ID, roomID)
```

```{r fig.width = 9}
ggplot(
  left_join(
    cdc_date %>% 
      filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(both$fakeroom, both$FAKEHALL, both$FAKEHOUS)) %>%
      select(-ID),
    cdcID,
    by = c("FAKEHALL", "PatientID"))) +
  aes(Date, ID, col = Event, group = ID) +
  geom_jitter(width = 0.05) +
  geom_path() +
  facet_wrap(~ FAKEHALL, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Time Course by Individual when Both Roommates Positive")
```

```{r}
tmp <- left_join(
    cdc_date %>% 
      filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(both$fakeroom, both$FAKEHALL, both$FAKEHOUS),
             Event == "CollectionDate") %>%
      select(-ID),
    cdcID,
    by = c("FAKEHALL", "PatientID"))
ggplot(tmp) +
  aes(Date, ID, col = factor(roomID), group = ID) +
  geom_point() +
  geom_path() +
  facet_wrap(~ FAKEHALL, scales = "free_y") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_color_manual(values = rep(2:7, length.out = length(unique(tmp$roomID)))) +
  ggtitle("Collection Dates by Individual when Both Roommates Positive")
```

```{r}
half_date <- left_join(
    cdc_date %>% 
      filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(half$fakeroom, half$FAKEHALL, half$FAKEHOUS),
             Event == "CollectionDate") %>%
      select(-ID),
    cdcIDh,
    by = c("FAKEHALL", "PatientID")) %>%
  group_by(PatientID) %>%
  mutate(Positive = c("Negative","Positive")[1 + max(Positive)]) %>%
  ungroup
```


```{r fig.width = 10}
ggplot(half_date) +
  aes(Date, ID, col = Positive, group = ID) +
  geom_point() +
  geom_path() +
  facet_wrap(~ FAKEHALL, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Collection Dates by Individual when One Roommate is Positive")
```

```{r}
ggplot(
  left_join(
    cdc_date %>% 
      filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(both$fakeroom, both$FAKEHALL, both$FAKEHOUS)) %>%
      select(-ID),
    cdcID,
    by = c("FAKEHALL", "PatientID")) %>%
    filter(FAKEHALL == 5, fakeroom != 14933)) + # not sure why this shows up
  aes(Date, ID, col = Event, group = ID) +
  geom_jitter(width = 0.05, size = 2) +
  facet_wrap(~ fakeroom, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("All Dates for Roommates Both Positive in Fake Hall 5")
```

```{r fig.height = 8, fig.width = 10}
ggplot(
  left_join(
    cdc_date %>% 
      filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(both$fakeroom, both$FAKEHALL, both$FAKEHOUS),
             Event == "CollectionDate") %>%
      select(-ID),
    cdcID,
    by = c("FAKEHALL", "PatientID")) %>%
    filter(FAKEHALL == 16)) +
  aes(Date, ID, col = factor(roomID), group = ID) +
  geom_point() +
  geom_path() +
  facet_wrap(~ FAKEHOUS, scales = "free_y") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_color_manual(values = rep(2:7, length.out = length(unique(tmp$roomID)))) +
 ggtitle("Collection Dates for Fake Hall 16 Houses with Roommates Both Positive")
```

\newpage

### Days Between Collections for Roommates

```{r}
ggplot(one %>%
         mutate(Positive = factor(Positive))) +
  aes(center, spread, col = Positive, size = HouseSize) +
  facet_wrap(~ FAKEHALL) +
  geom_jitter(width = 0.1, alpha = 0.25) +
  ggtitle("Days between Last Collection Dates per Room by House within Hall")
```

```{r}
# Get one record per student
house <- cdc_date %>%
  filter(Event == "CollectionDate",
         !is.na(Date),
         !is.na(Positive)) %>%
  group_by(FAKEHALL, FAKEHOUS, Room,
           fakeroom, PatientID) %>%
  arrange(Date) %>%
  summarize(PrevDate = nth(Date, -2),
            Date = last(Date),
            Positive = last(Positive)) %>%
  ungroup
roomsize <- house %>%
  count(FAKEHALL, FAKEHOUS, fakeroom, Room)
# Restrict to rooms with exactly two students (avoiding turnover for now)
house <-
  left_join(house, roomsize, by = c("FAKEHALL", "FAKEHOUS", "fakeroom", "Room")) %>%
  filter(n == 2) %>%
  select(-n) %>%
  group_by(FAKEHALL, FAKEHOUS) %>%
  mutate(students = n()) %>%
  ungroup %>%
  mutate(house = FAKEHOUS,
         FAKEHOUS = paste0(FAKEHOUS, " (", students, ")"))
```

```{r}
one_date <- house %>%
  group_by(FAKEHALL, FAKEHOUS, house, fakeroom) %>%
  arrange(Date) %>%
  summarize(Delay = max(Date) - min(Date),
         Positive = sum(Positive),
         Date = first(Date)) %>%
  ungroup %>%
  filter(Positive == 2) %>%
  # Kludge used once only
  group_by(FAKEHALL) %>%
  mutate(roomID = factor(rank(10000 * house + fakeroom))) %>%
  ungroup
```

```{r}
ggplot(one_date) +
  aes(Date, Delay, col = roomID) +
  geom_jitter() +
  theme(legend.position = "none") +
  scale_color_manual(values = rep(2:7, length.out = length(unique(one_date$roomID)))) +
  facet_wrap(~ FAKEHALL) +
  ggtitle("Delay in Collection Dates between Two Positive Roommates")
```

\newpage

### Off Campus Summary

```{r}
# Need to download this file; could use boxr package
off <- read.csv("data/matchforCDC-PHI.csv") %>%
  filter(Residence_Hall == "off campus") %>%
  select(PatientID, 
         ResultDate, CollectionDate, ConfirmedDate, TracedDate, Positive) %>%
  filter(!is.na(PatientID),
         !is.na(Positive)) %>%
  pivot_longer(ResultDate:TracedDate, names_to = "Event", values_to = "Date") %>%
  distinct(PatientID, Date, Event, .keep_all = TRUE) %>%
  mutate(Event = factor(Event, c("CollectionDate", "ResultDate", "ConfirmedDate", "TracedDate")),
         Date = as.Date(Date, "%m/%d/%Y")) %>%
  filter(Date > as.Date("2020-01-01"))
```

```{r}
off %>%
  filter(Event == "CollectionDate") %>%
  count(Positive)
```

```{r}
ggplot(off %>% filter(Event == "CollectionDate")) +
  aes(Date, col = factor(Positive), group = Positive) +
  geom_density()
```


```{r}
ggplot(off %>%
         filter(Event == "CollectionDate", Positive == 1) %>%
         group_by(Date) %>%
         summarize(Positive = sum(Positive)) %>%
         ungroup %>%
         arrange(Date) %>%
         mutate(Positive = cumsum(Positive))) +
  aes(Date, Positive) +
  geom_line() +
  scale_y_log10()
```

```{r}
knitr::knit_exit()
```

### Older Stuff

```{r}
tmp <- (cdc %>% count(PatientID, name = "tests") %>% count(tests) %>% t)
colnames(tmp) <- rep("", ncol(tmp))
tmp
```


```{r}
tmp <- cdc %>% 
  count(FAKEHALL, FAKEHOUS, PatientID, name = "count") %>%
  mutate(count = factor(ifelse(count > 5, ">5", as.character(count)), c(1:5, ">5"))) %>%
  count(FAKEHALL, FAKEHOUS, count) %>%
  mutate(FAKEHALL = factor(FAKEHALL))
ggplot(tmp) +
  aes(count, n, col = FAKEHALL, group = FAKEHALL) +
  geom_point() +
  geom_path() +
  scale_y_log10() +
  theme(legend.position = "none") +
  xlab("Number of Tests") +
  ylab("Student Count") +
  ggtitle("How Many Tests per Student by Hall?")
```

```{r}
ggplot(cdc_date %>% filter(PatientID %in% pos, FAKEHALL == FAKEHALL[1])) +
  aes(Date, ID, col = Event, group = ID) +
  geom_point() +
  geom_path() +
  ggtitle("Positive")
```


```{r}
ggplot(cdc_date %>% filter(PatientID %in% pos, FAKEHALL == FAKEHALL[1], Event %in% c("ConfirmedDate", "TracedDate"))) +
  aes(Date, ID, col = Event, group = ID) +
  geom_point() +
  geom_path() +
  ggtitle("Positive")
```


```{r}
ggplot(cdc_date %>% 
         filter(PatientID %in% pos, 
                FAKEHALL == FAKEHALL[1], 
                Event %in% c("ConfirmedDate", "TracedDate")) %>%
         mutate(ID = idf(ID, Date, FAKEHOUS))) +
  aes(Date, ID, col = Event, group = ID) +
  geom_point() +
  geom_path() +
  facet_wrap(~ FAKEHOUS, scales = "free_y") +
  ggtitle("Positive")
```

Number of roommates positive by house.

```{r}
cdc_date %>%
  filter(PatientID %in% pos, FAKEHALL == FAKEHALL[1], Event %in% c("ConfirmedDate", "TracedDate")) %>%
  count(fakeroom, FAKEHOUS, name = "nc") %>%
  count(FAKEHOUS, nc) %>%
  mutate(nc = paste0("R", nc)) %>%
  pivot_wider(names_from = "nc", values_from = "n", values_fill = 0) %>%
  arrange(desc(R1 + R2 + R3 + R4))
```
Now would like to look at both positive and negative by house and room to see pattern.


```{r}
ggplot(cdc_date %>% filter(FAKEHALL == FAKEHALL[1], Event %in% c("ConfirmedDate")) %>%
         mutate(Outcome = c("Negative","Positive")[1+Positive])) +
  aes(Date, ID, col = Outcome, group = ID) +
  geom_point() +
  geom_path() +
  facet_wrap(~ FAKEHOUS, scales = "free_y") +
  ggtitle("Negative & Positive")
```

### Delay Code Never Debugged Completely


```{r}
# do this for each house
# get median (and maybe IQR?) by same/diff and pos=0,1,2
# compare across houses in hall
# compare across halls
room_rank <- function(fakeroom) {
  roomID <- rank(sort(unique(fakeroom)))
  names(roomID) <- sort(unique(fakeroom))
  roomID[as.character(fakeroom)]
}
delta_house <- function(object) {
  object <- object %>%
    filter(Positive == 1) %>%
    arrange(Date)
  outer_lower <- function(x,y,f) {
    out <- outer(x, y, f)
    out[lower.tri(out)]
  }
  days <- outer_lower(object$Date, object$Date, "-")
  room <- outer_lower(object$fakeroom, object$fakeroom, "==")
  # Get first date
  Date <- outer_lower(object$Date, object$Date, function(x,y) y)
  # Get first and second room ID
  roomID <- room_rank(object$fakeroom)
  second <- outer(roomID, roomID, function(x,y) y)
  first <- second[lower.tri(second)]
  second <- t(second)[lower.tri(second)]
  as_tibble(
    data.frame(Date = Date,
               days = days, 
               room = c("Diff","Same")[1+room],
               first = first,
               second = second))
}
```

```{r}
delta_house(house %>% filter(FAKEHALL == 16, FAKEHOUS == 126)) %>%
  arrange(second, days) %>%
  group_by(second, room) %>%
  filter(days == min(days)) %>%
  ungroup %>%
  arrange(Date)
```

```{r}
delay_house <- function(house) {
  diffs <- diff_house(house) %>%
    filter(pos > 0)
  # Sames have room with 1 or 2 positive
  sames <- diffs %>%
    filter(room == "Same") %>%
    select(-room)
  # Diffs are pairs 
  diffs <- diffs %>%
    filter(#days >= 0,
           roomID %in% sames$roomID,
           room == "Diff") %>%
    select(-room)
  left_join(diffs, sames, 
            by = "roomID", 
            suffix = c("_d","_s")) %>%
    mutate(days = days_d - days_s,
           pos_s = c("1.0","1.1","2.0","2.1")[2 * (pos_s - 1) + pos_d])
}
```

```{r}
delay_hall <- function(object) {
  bind_rows(
    map(split(object, object$FAKEHOUS), delay_house),
    .id = "house")
}
```

```{r}
out <- delay_hall(house %>% filter(FAKEHALL == 16))
```

```{r}
object <- house %>% filter(FAKEHALL == 8, FAKEHOUS == 36)
roomID <- rank(sort(unique(object$fakeroom)))
names(roomID) <- sort(unique(object$fakeroom))
d <- diff_house(object)
(tmp <- d %>% arrange(desc(pos), days) %>% filter(room == "Same", pos > 0))
object %>% filter(fakeroom %in% names(roomID)[roomID %in% tmp$roomID])
d %>% arrange(desc(pos), days)
```

```{r}
ggplot(out %>% filter(house == 36)) +
  aes(days, pos_s, col = factor(roomID)) +
  geom_boxplot(outlier.shape = NA) +
  geom_vline(xintercept = 0, col = "gray") +
  geom_jitter(height = 0.25) +
  ylab("Status of Proband Room to Status of Other Student") +
  xlab("Difference in Days to Last Collection over Proband Roommate")
```

```{r}
ggplot(out %>% filter(pos_s %in% c("1.1","2.1"))) +
  aes(days, pos_s, col = factor(roomID)) +
  geom_boxplot(outlier.shape = NA, col = 1) +
  geom_vline(xintercept = 0, col = "gray") +
  geom_jitter(height = 0.25) +
  facet_wrap(~ house) +
  theme(legend.position = "none") +
  ylab("Status of Proband Room to Status of Other Student") +
  xlab("Difference in Days to Last Collection over Proband Roommate")
```
