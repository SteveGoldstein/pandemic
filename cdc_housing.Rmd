---
title: "CDC_Housing"
author: "`r paste('Brian Yandell,', format(Sys.time(), '%d %B %Y'))`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 7, fig.height = 5)
```

This document summarizes housing information. The R code file can be found in the [pandemic github repository](https://github.com/UW-Madison-DataScience/pandemic/blob/master/cdc_housing.Rmd).

```{r}
library(tidyverse)
library(lubridate)
kprint <- function(x) {
  if(interactive()) {
    print(x)
  } else {
    knitr::kable(x)
  }
}
```

```{r}
filename <- scan("data/housing_data_url.txt", "text")
# Need to download this file; could use boxr package
cdc0 <- read.csv("data/matchforCDC-PHI.csv") %>%
  select(PatientID, 
         ResultDate, CollectionDate, ConfirmedDate, TracedDate,
         Residence_Hall, Hall, House_Name, Room,
         fakeroom, FAKEHALL, FAKEHOUS, Positive) %>%
  filter(!is.na(PatientID)) %>%
  mutate(FAKEHALL = ifelse(is.na(FAKEHALL), -1, FAKEHALL),
         Campus = ifelse(Residence_Hall == "off campus", "off", "on")) %>%
  select(-Residence_Hall)
# Only a few off campus and no positives, so drop them.
cdc0 <- cdc0 %>%
  filter(Campus == "on") %>%
  select(-Campus)
```

```{r}
SmallHall <- (cdc0 %>%
  filter(Positive == 1) %>%
  count(FAKEHALL) %>%
  filter(n < 15))$FAKEHALL
cdc0 <- cdc0 %>%
  mutate(FAKEHALL = ifelse(FAKEHALL %in% SmallHall, 0, FAKEHALL))
```

```{r}
cdc <- cdc0 %>%
  filter(FAKEHALL != -1)
```

```{r}
IDs <- sort(unique(cdc$PatientID))
```

```{r}
cdc_date <- cdc %>%
  pivot_longer(ResultDate:TracedDate, names_to = "Event", values_to = "Date") %>%
  distinct(PatientID, Date, Event, .keep_all = TRUE) %>%
  mutate(Event = factor(Event, c("CollectionDate", "ResultDate", "ConfirmedDate", "TracedDate")),
         ID = match(PatientID, IDs),
         Date = as.Date(Date, "%m/%d/%Y")) %>%
  filter(Date > as.Date("2020-01-01"))
```

```{r}
countroom <- function(room) {
  out <- room %>%
    mutate(PatientID = paste0("N", match(PatientID, sort(unique(PatientID)))))
  if(length(unique(out$PatientID)) > 1) {
    out <- out%>%
      pivot_wider(names_from = "PatientID", values_from = "Positive") %>%
      arrange(Date) %>%
      fill(contains("N")) %>%
      pivot_longer(any_of(paste0("N",1:10)), 
                   names_to = "roommate", values_to = "score") %>%
      ungroup %>%
      group_by(Date) %>%
      summarize(score = sum(score, na.rm = TRUE)) %>%
      ungroup
  }
  out
}
```

```{r}
oneroom <- cdc_date %>%
  filter(Event == "CollectionDate") %>%
  group_by(FAKEHALL, FAKEHOUS, fakeroom, PatientID) %>%
  summarize(Date = ifelse(max(Positive) == 1, min(Date[Positive == 1]), max(Date)),
            Positive = max(Positive)) %>%
  ungroup %>%
  group_by(FAKEHALL, FAKEHOUS, fakeroom) %>%
  arrange(Date) %>%
  mutate(Positive = cumsum(Positive),
         Date = max(Date) - min(Date),
         Positive = max(Positive),
         Roommates = n()) %>%
  ungroup %>%
  filter(Roommates == 2,
         !is.na(Date))
one <- oneroom %>%
  group_by(FAKEHALL, FAKEHOUS, Positive) %>%
  summarize(center = median(Date),
            spread = IQR(Date),
            HouseSize = n()) %>%
  ungroup
```

Number of rooms with 0, 1 or 2 students positive:

```{r}
one %>%
  group_by(FAKEHALL, Positive) %>%
  summarize(HouseSize = sum(HouseSize)) %>%
  ungroup %>%
  mutate(Positive = paste0("Pos", Positive)) %>%
  pivot_wider(names_from = "Positive", values_from = "HouseSize", values_fill = 0) %>%
  mutate(Rooms = Pos0 + Pos1 + Pos2,
         PctPos = round(100 * (Pos1 + 2 * Pos2) / Rooms, 2)) %>%
  arrange(desc(PctPos)) %>%
  kprint()
```
`FAKEHALL` 0 is aggregation of halls with fewer than 15 students reporting. Next plot summarizes by House (point) within Hall (facet) differences within rooms of last collection date; center = median, spread = IQR.
Subsequent plots show individual students per horizontal line (sometimes with a little jitter), with roommates adjacent to each other. Coloring highlights time course of dates, positive vs negative, or room.

\newpage

### Days Between Collections for Roommates

```{r}
ggplot(one %>%
         mutate(Positive = factor(Positive))) +
  aes(center, spread, col = Positive, size = HouseSize) +
  facet_wrap(~ FAKEHALL) +
  geom_jitter(width = 0.1, alpha = 0.25) +
  ggtitle("Days between Last Collection Dates per Room by House within Hall")
```

```{r}
# Get one record per student
house <- cdc_date %>%
  filter(Event == "CollectionDate",
         !is.na(Date),
         !is.na(Positive)) %>%
  group_by(FAKEHALL, FAKEHOUS, Room,
           fakeroom, PatientID) %>%
  arrange(Date) %>%
  summarize(PrevDate = nth(Date, -2),
            Date = last(Date),
            Positive = last(Positive)) %>%
  ungroup
roomsize <- house %>%
  count(FAKEHALL, FAKEHOUS, fakeroom, Room)
house <-
  left_join(house, roomsize, by = c("FAKEHALL", "FAKEHOUS", "fakeroom", "Room")) %>%
  filter(n == 2) %>%
  select(-n)
```

```{r}
one_date <- house %>%
  group_by(FAKEHALL, FAKEHOUS, fakeroom) %>%
  arrange(Date) %>%
  summarize(Delay = max(Date) - min(Date),
         Positive = sum(Positive),
         Date = first(Date)) %>%
  ungroup %>%
  filter(Positive == 2) %>%
  group_by(FAKEHALL) %>%
  mutate(roomID = factor(rank(10000 * FAKEHOUS + fakeroom))) %>%
  ungroup
```

```{r}
ggplot(one_date) +
  aes(Date, Delay, col = roomID) +
  geom_jitter() +
  theme(legend.position = "none") +
  scale_color_manual(values = rep(2:7, length.out = length(unique(one_date$roomID)))) +
  facet_wrap(~ FAKEHALL) +
  ggtitle("Delay in Collection Dates between Two Positive Roommates")
```

### Positive Cases within Rooms over Date

Idea here is to just look at dates of positive cases and link cases within rooms by a horizontal line. First plots colors rooms by number of positive cases. Early plots have two points per students for the most recent two tests. Later plots color rooms by house to look for patterns that cut across houses in halls.

```{r}
room_rank <- function(fakeroom) {
  roomID <- rank(sort(unique(fakeroom)))
  names(roomID) <- sort(unique(fakeroom))
  roomID[as.character(fakeroom)]
}
pair_house <- function(house, neg = FALSE) {
  nhouse <- nrow(house)
  pos_pair <- house %>%
    arrange(Date, fakeroom)
  if(!neg) {
    pos_pair <- pos_pair %>%
      filter(Positive == 1)
  }
  pos_room <- pos_pair %>%
    group_by(fakeroom) %>%
    arrange(Date) %>%
    summarize(RoomPos = sum(Positive),
              RoomID = Room[1]) %>%
    ungroup %>%
    mutate(RoomID = 1 + RoomID - min(RoomID))
  out <- 
    left_join(
      pos_pair,
      pos_room,
      by = "fakeroom") %>%
    mutate(RoomPos = factor(RoomPos),
          students = nhouse)
  if(nrow(out)) {
    out %>%
    # jitter roommates if 2 entries per room
    group_by(Room) %>%
    mutate(RoomID = ifelse(!neg & RoomPos == 1, RoomID, RoomID + c(-0.2,0.2))) %>%
    ungroup %>%
    pivot_longer(PrevDate:Date, names_to = "Prev", values_to = "Date") %>%
    group_by(RoomID) %>%
    mutate(TestResult = ifelse(neg & Positive == 0, rep(1,2), 1:2)) %>%
    ungroup %>%
    mutate(TestResult = c("Negative","Positive")[TestResult])
  } else {
    out 
  }
}
```

```{r fig.height = 4}
ggplot(pair_house(house %>% filter(FAKEHALL == 10, FAKEHOUS == 39))) +
  aes(Date, RoomID, col = RoomPos, group = RoomID, shape = TestResult) +
  geom_line() +
  geom_point() +
#  facet_wrap(~ house, scale = "free") +
#  theme(legend.position = "none") +
  scale_shape_manual(values = c(21,19)) +
  ggtitle("Positive Students by Room Burden across Rooms in House")

```

```{r fig.height = 4}
ggplot(pair_house(house %>% filter(FAKEHALL == 10, FAKEHOUS == 39), TRUE)) +
  aes(Date, RoomID, col = RoomPos, group = RoomID, shape = TestResult) +
  geom_line() +
  geom_point() +
#  facet_wrap(~ house, scale = "free") +
#  theme(legend.position = "none") +
  scale_shape_manual(values = c(21,19)) +
  ggtitle("All Students by Room Burden across Rooms in House")
```

```{r}
plot_hall <- function(house, hallID, neg = FALSE) {
object <- house %>% filter(FAKEHALL == hallID)
out <- bind_rows(
    map(split(object, object$FAKEHOUS), pair_house, neg),
    .id = "house")
if(neg) {
  gtitle <- "All Students by Room Burden across House Rooms in Hall"
} else {
  gtitle <- "Positive Students by Room Burden across House Rooms in Hall"
}
ggplot(out) +
  aes(Date, RoomID, col = RoomPos, group = RoomID, shape = TestResult) +
  geom_line() +
  geom_point() +
  facet_wrap(~ house) +
  scale_shape_manual(values = c(21,19)) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle(paste(gtitle, hallID))
}
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 10)
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 16)
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 10, TRUE)
```

```{r fig.width = 7, fig.height = 9}
plot_hall(house, 16, TRUE)
```

```{r}
pair_hall <- function(object) {
  bind_rows(
    map(split(object, object$FAKEHOUS), pair_house),
    .id = "house") %>% 
  filter(Prev == "Date") %>%
  mutate(house = paste0(house, " (", students, ")"),
         Week = (epiweek(Date))) %>%
  group_by(house, Week) %>%
  summarize(count = sum(Positive)) %>%
#  ungroup %>%
#  arrange(Date) %>%
#  group_by(house) %>%
#  mutate(count = cumsum(count)) %>%
  ungroup
}
```

```{r}
out <- pair_hall(house %>% filter(FAKEHALL == 10))
```

```{r fig.width = 10, fig.height = 7}
ggplot(out) +
  aes(Week, house, size = count) +
  geom_line(size = 1) +
  geom_point() +
#  facet_wrap(~ house, scale = "free") +
  theme(legend.position = "none") +
  ggtitle("Positive Collection Dates by Room Burden across Rooms in House")
```

```{r}
out <- 
  bind_rows(
    map(split(house, house$FAKEHALL), pair_hall),
    .id = "hall")
```

```{r fig.width = 10, fig.height = 10}
ggplot(out %>% filter(hall %in% c(10, 16))) +
  aes(Week, house, size = count) +
  geom_line(size = 1) +
  geom_point() +
  facet_wrap(~ hall, scales = "free") +
  theme(legend.position = "none") +
  ggtitle("Positive Collection Dates by House across Halls")
```

```{r fig.width = 10, fig.height = 10}
ggplot(out) +
  aes(Week, house, size = count) +
  geom_line(size = 1) +
  geom_point() +
  facet_wrap(~ hall, scales = "free") +
  theme(legend.position = "none") +
  ggtitle("Positive Collection Dates by House across Halls")
```

\newpage

### Same vs Different Rooms

```{r}
diff_house <- function(object) {
  object <- arrange(object, -Positive, Date)
  days <- outer(object$Date, object$Date, "-")
  days <- days[lower.tri(days)]
  room <- outer(object$fakeroom, object$fakeroom, "==")
  room <- room[lower.tri(room)]
  pos <- outer(object$Positive, object$Positive, "+")
  pos <- pos[lower.tri(pos)]
  roomID <- rank(sort(unique(object$fakeroom)))
  names(roomID) <- sort(unique(object$fakeroom))
  roomID <- outer(object$fakeroom, roomID[as.character(object$fakeroom)], function(x,y) y)
  roomID <- roomID[lower.tri(roomID)]
  as_tibble(
    data.frame(days = days, 
               room = c("Diff","Same")[1+room],
               pos = pos,
               roomID = roomID))
}
```

```{r}
diff_hall <- function(object) {
  bind_rows(
    map(split(object, object$FAKEHOUS), diff_house),
    .id = "house") %>%
  group_by(house, room, pos) %>%
  summarize(days_iqr = IQR(days),
            days = median(days),
            size = n()) %>%
  ungroup
}
```

```{r}
out <- 
  bind_rows(
    map(split(house, house$FAKEHALL), diff_hall),
    .id = "hall")
```

Compare all pairs of students in each house within each hall. Note middle column compares two students where one is positive and one is negative. Values below 0 for median days signify that the positive students were detected after that most recent test for the negative students.

```{r fig.width = 6, fig.height = 7}
ggplot(out %>% 
         mutate(pos = paste(pos, "Positive"),
                hall = paste("Hall", hall))) +
  aes(days, days_iqr, col = room, size = size) +
  facet_grid(hall ~ pos, scale = "free") +
  xlab("Median Days per House") +
  ylab("Day Spread per House") +
  geom_point(alpha = 0.5) +
  ggtitle("Delay in Collection Dates for Same or Different Rooms in House")
```

\newpage

### Cumulative Counts of Positives by Collection Date

```{r}
cdc_sum <- cdc_date %>%
  filter(Event == "CollectionDate", Positive == 1) %>%
  arrange(Date) %>%
  count(FAKEHALL, Date, name = "count") %>%
  group_by(FAKEHALL) %>%
  mutate(count = cumsum(count)) %>%
  ungroup
cdc_tot <- cdc_date %>%
  filter(Event == "CollectionDate", Positive == 1) %>%
  arrange(Date) %>%
  count(Date, name = "all") %>%
  mutate(all = cumsum(all))
cdc_sum <- left_join(
  cdc_sum,
  cdc_tot,
  by = "Date")
```

```{r}
ggplot(cdc_sum) +
  aes(Date, count, col = factor(FAKEHALL), group = factor(FAKEHALL)) +
  scale_y_log10() +
  theme(legend.position = "none") +
  ylab("Cumulative Positive by Hall") +
  geom_line(size = 2) +
  ggtitle("Cumulative Positives by Hall over Time")
```

```{r}
ggplot(cdc_sum %>% mutate(Hall = factor(FAKEHALL))) +
  aes(all, count, col = Hall, group = Hall) +
  geom_line(size = 2) +
  geom_abline(slope = 1, intercept = 0, col = "gray") +
  scale_x_log10() +
  scale_y_log10() +
  xlab("Cumulative Positive Overall") +
  ylab("Cumulative Positive by Hall") +
  theme(legend.position = "none") +
  ggtitle("Breakdown of Cumulative Positives by Hall")
```

### Summaries by student within rooms

```{r}
both <- oneroom %>%
  filter(Positive == 2) %>%
  select(FAKEHALL, FAKEHOUS, fakeroom, PatientID)
half <- oneroom %>%
  filter(Positive == 1) %>%
  select(FAKEHALL, FAKEHOUS, fakeroom, PatientID)
cdcID <- cdc_date %>% 
  filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(both$fakeroom, both$FAKEHALL, both$FAKEHOUS)) %>%
  group_by(FAKEHALL, FAKEHOUS, PatientID) %>%
  summarize(Date = min(Date),
            fakeroom = fakeroom[1]) %>%
  ungroup %>%
  group_by(FAKEHALL) %>%
  mutate(ID = 0.25 + rank(10000 * FAKEHOUS + fakeroom, ties.method = "random") / 2,
         roomID = rank(10000 * FAKEHOUS + fakeroom)) %>%
  ungroup %>%
  select(FAKEHALL, PatientID, ID, roomID)
cdcIDh <- cdc_date %>% 
  filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(half$fakeroom, half$FAKEHALL, half$FAKEHOUS)) %>%
  group_by(FAKEHALL, FAKEHOUS, PatientID) %>%
  summarize(Date = min(Date),
            fakeroom = fakeroom[1]) %>%
  ungroup %>%
  group_by(FAKEHALL) %>%
  mutate(ID = 0.25 +rank(10000 * FAKEHOUS + fakeroom, ties.method = "random") / 2,
         roomID = rank(10000 * FAKEHOUS + fakeroom)) %>%
  ungroup %>%
  select(FAKEHALL, PatientID, ID, roomID)
```

```{r fig.width = 9}
ggplot(
  left_join(
    cdc_date %>% 
      filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(both$fakeroom, both$FAKEHALL, both$FAKEHOUS)) %>%
      select(-ID),
    cdcID,
    by = c("FAKEHALL", "PatientID"))) +
  aes(Date, ID, col = Event, group = ID) +
  geom_jitter(width = 0.05) +
  geom_path() +
  facet_wrap(~ FAKEHALL, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Time Course by Individual when Both Roommates Positive")
```

```{r}
tmp <- left_join(
    cdc_date %>% 
      filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(both$fakeroom, both$FAKEHALL, both$FAKEHOUS),
             Event == "CollectionDate") %>%
      select(-ID),
    cdcID,
    by = c("FAKEHALL", "PatientID"))
ggplot(tmp) +
  aes(Date, ID, col = factor(roomID), group = ID) +
  geom_point() +
  geom_path() +
  facet_wrap(~ FAKEHALL, scales = "free_y") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_color_manual(values = rep(2:7, length.out = length(unique(tmp$roomID)))) +
  ggtitle("Collection Dates by Individual when Both Roommates Positive")
```

```{r}
half_date <- left_join(
    cdc_date %>% 
      filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(half$fakeroom, half$FAKEHALL, half$FAKEHOUS),
             Event == "CollectionDate") %>%
      select(-ID),
    cdcIDh,
    by = c("FAKEHALL", "PatientID")) %>%
  group_by(PatientID) %>%
  mutate(Positive = c("Negative","Positive")[1 + max(Positive)]) %>%
  ungroup
```


```{r fig.width = 10}
ggplot(half_date) +
  aes(Date, ID, col = Positive, group = ID) +
  geom_point() +
  geom_path() +
  facet_wrap(~ FAKEHALL, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Collection Dates by Individual when One Roommate is Positive")
```

```{r}
ggplot(
  left_join(
    cdc_date %>% 
      filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(both$fakeroom, both$FAKEHALL, both$FAKEHOUS)) %>%
      select(-ID),
    cdcID,
    by = c("FAKEHALL", "PatientID")) %>%
    filter(FAKEHALL == 5, fakeroom != 14933)) + # not sure why this shows up
  aes(Date, ID, col = Event, group = ID) +
  geom_jitter(width = 0.05, size = 2) +
  facet_wrap(~ fakeroom, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("All Dates for Roommates Both Positive in Fake Hall 5")
```

```{r fig.height = 8, fig.width = 10}
ggplot(
  left_join(
    cdc_date %>% 
      filter(paste(fakeroom, FAKEHALL, FAKEHOUS) %in% paste(both$fakeroom, both$FAKEHALL, both$FAKEHOUS),
             Event == "CollectionDate") %>%
      select(-ID),
    cdcID,
    by = c("FAKEHALL", "PatientID")) %>%
    filter(FAKEHALL == 16)) +
  aes(Date, ID, col = factor(roomID), group = ID) +
  geom_point() +
  geom_path() +
  facet_wrap(~ FAKEHOUS, scales = "free_y") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_color_manual(values = rep(2:7, length.out = length(unique(tmp$roomID)))) +
 ggtitle("Collection Dates for Fake Hall 16 Houses with Roommates Both Positive")
```

```{r}
knitr::knit_exit()
```

### Older Stuff

```{r}
tmp <- (cdc %>% count(PatientID, name = "tests") %>% count(tests) %>% t)
colnames(tmp) <- rep("", ncol(tmp))
tmp
```


```{r}
tmp <- cdc %>% 
  count(FAKEHALL, FAKEHOUS, PatientID, name = "count") %>%
  mutate(count = factor(ifelse(count > 5, ">5", as.character(count)), c(1:5, ">5"))) %>%
  count(FAKEHALL, FAKEHOUS, count) %>%
  mutate(FAKEHALL = factor(FAKEHALL))
ggplot(tmp) +
  aes(count, n, col = FAKEHALL, group = FAKEHALL) +
  geom_point() +
  geom_path() +
  scale_y_log10() +
  theme(legend.position = "none") +
  xlab("Number of Tests") +
  ylab("Student Count") +
  ggtitle("How Many Tests per Student by Hall?")
```

```{r}
ggplot(cdc_date %>% filter(PatientID %in% pos, FAKEHALL == FAKEHALL[1])) +
  aes(Date, ID, col = Event, group = ID) +
  geom_point() +
  geom_path() +
  ggtitle("Positive")
```


```{r}
ggplot(cdc_date %>% filter(PatientID %in% pos, FAKEHALL == FAKEHALL[1], Event %in% c("ConfirmedDate", "TracedDate"))) +
  aes(Date, ID, col = Event, group = ID) +
  geom_point() +
  geom_path() +
  ggtitle("Positive")
```


```{r}
ggplot(cdc_date %>% 
         filter(PatientID %in% pos, 
                FAKEHALL == FAKEHALL[1], 
                Event %in% c("ConfirmedDate", "TracedDate")) %>%
         mutate(ID = idf(ID, Date, FAKEHOUS))) +
  aes(Date, ID, col = Event, group = ID) +
  geom_point() +
  geom_path() +
  facet_wrap(~ FAKEHOUS, scales = "free_y") +
  ggtitle("Positive")
```

Number of roommates positive by house.

```{r}
cdc_date %>%
  filter(PatientID %in% pos, FAKEHALL == FAKEHALL[1], Event %in% c("ConfirmedDate", "TracedDate")) %>%
  count(fakeroom, FAKEHOUS, name = "nc") %>%
  count(FAKEHOUS, nc) %>%
  mutate(nc = paste0("R", nc)) %>%
  pivot_wider(names_from = "nc", values_from = "n", values_fill = 0) %>%
  arrange(desc(R1 + R2 + R3 + R4))
```
Now would like to look at both positive and negative by house and room to see pattern.


```{r}
ggplot(cdc_date %>% filter(FAKEHALL == FAKEHALL[1], Event %in% c("ConfirmedDate")) %>%
         mutate(Outcome = c("Negative","Positive")[1+Positive])) +
  aes(Date, ID, col = Outcome, group = ID) +
  geom_point() +
  geom_path() +
  facet_wrap(~ FAKEHOUS, scales = "free_y") +
  ggtitle("Negative & Positive")
```

